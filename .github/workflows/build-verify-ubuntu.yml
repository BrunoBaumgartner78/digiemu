name: Build Verify (Ubuntu)

on:
  push:
    branches: [ "main", "staging", "develop" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      NODE_ENV: production
      # Prisma braucht DIRECT_URL wenn es im schema steht.
      # Wenn du es nicht als Secret gesetzt hast: fallback auf DATABASE_URL.
      DATABASE_URL: "postgresql://ci:ci@127.0.0.1:5432/ci?schema=public"
      DIRECT_URL: "postgresql://ci:ci@127.0.0.1:5432/ci?schema=public"

      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

      # Falls Firebase Admin im Build referenced wird (manche Routes importen das):
      FIREBASE_ADMIN_PROJECT_ID: ${{ secrets.FIREBASE_ADMIN_PROJECT_ID }}
      FIREBASE_ADMIN_CLIENT_EMAIL: ${{ secrets.FIREBASE_ADMIN_CLIENT_EMAIL }}
      FIREBASE_ADMIN_PRIVATE_KEY: ${{ secrets.FIREBASE_ADMIN_PRIVATE_KEY }}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}

      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (incl. dev)
        run: npm ci --include=dev

      - name: CI env fallback (Stripe)
        shell: bash
        run: |
          if [ -z "${STRIPE_SECRET_KEY:-}" ]; then
            echo "STRIPE_SECRET_KEY=sk_test_dummy" >> "$GITHUB_ENV"
          fi
          if [ -z "${STRIPE_WEBHOOK_SECRET:-}" ]; then
            echo "STRIPE_WEBHOOK_SECRET=whsec_dummy" >> "$GITHUB_ENV"
          fi

      - name: Sanity check env (DATABASE_URL/DIRECT_URL)
        shell: bash
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL is missing."
            exit 1
          else
            echo "DATABASE_URL is set."
          fi

          if [ -z "${DIRECT_URL}" ]; then
            echo "DIRECT_URL is missing (schema expects it)."
            exit 1
          else
            echo "DIRECT_URL is set."
          fi

      - name: Prisma generate
        run: npm run prisma:generate

      # Optional but recommended in PR checks:
      - name: Lint
        run: npm run lint --if-present

      # PR checks: typecheck only (no next build)
      - name: Typecheck
        run: npm run typecheck
