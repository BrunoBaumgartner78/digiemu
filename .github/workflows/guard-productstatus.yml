name: hotfix-guard-productstatus

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  guard-productstatus:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Hard fail: Product.status darf niemals "APPROVED" sein
      - name: Guard - forbid ProductStatus = APPROVED
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking for illegal ProductStatus usage: status: \"APPROVED\" on prisma.product..."
          # Direkt falsch: prisma.product.*( ... status: "APPROVED" ...)
          if grep -RIn --include='*.ts' --include='*.tsx' 'prisma\.product\.' src | grep -E 'status\s*:\s*"APPROVED"' >/dev/null; then
            echo "::error::Found invalid ProductStatus value \"APPROVED\" used in prisma.product.* update/create/find queries."
            echo "---- matches ----"
            grep -RIn --include='*.ts' --include='*.tsx' 'prisma\.product\.' src | grep -E 'status\s*:\s*"APPROVED"' || true
            exit 1
          fi

      # 2) Soft fail: acceptProductStatuses darf nie APPROVED enthalten (VendorStatus ist separat!)
      - name: Guard - forbid APPROVED in acceptProductStatuses
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking acceptProductStatuses is not polluted with VendorStatus.APPROVED..."
          # typische FÃ¤lle:
          # acceptProductStatuses: ["APPROVED"]
          # acceptProductStatuses: [VendorStatus.APPROVED]
          if grep -RIn --include='*.ts' --include='*.tsx' 'acceptProductStatuses' src | grep -E 'APPROVED' >/dev/null; then
            echo "::error::Found APPROVED inside acceptProductStatuses. This likely mixes VendorStatus into ProductStatus and can crash Postgres enum ProductStatus."
            echo "---- matches ----"
            grep -RIn --include='*.ts' --include='*.tsx' 'acceptProductStatuses' src | grep -E 'APPROVED' || true
            exit 1
          fi

      # Optional: schneller TS-Check (ohne Full build)
      - name: Typecheck (optional)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci
            npm run -s typecheck || npm run -s lint || true
          fi
