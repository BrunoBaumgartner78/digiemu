name: Blocked Vendor Guards

on:
  push:
    branches: [ "main", "develop", "staging" ]
  pull_request:
    branches: [ "main", "develop", "staging" ]

jobs:
  guards:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      # optional, aber empfohlen:
      - name: Lint
        run: npm run lint --if-present

      - name: Build
        run: npm run build

      # ---------- Guard: Product Page must have blocked checks ----------
      - name: Guard - product page must block inactive/non-ACTIVE and blocked vendors
        run: |
          FILE="src/app/product/[id]/page.tsx"
          test -f "$FILE" || (echo "Missing file: $FILE" && exit 1)

          # must contain both checks (exact strings)
          grep -F 'if (!p || !p.isActive || p.status !== "ACTIVE") notFound();' "$FILE" \
            || (echo "Missing ACTIVE guard in $FILE" && exit 1)

          grep -F 'if (p.vendor?.isBlocked) notFound();' "$FILE" \
            || (echo "Missing vendor blocked guard in $FILE" && exit 1)

      - name: Guard - relatedProducts must filter blocked vendors
        run: |
          FILE="src/app/product/[id]/page.tsx"
          # ensure relatedProducts query includes vendor isBlocked false
          grep -F 'vendor: { isBlocked: false }' "$FILE" \
            || (echo "Missing relatedProducts vendor block filter in $FILE" && exit 1)

      # ---------- Guard: Marketplace must filter blocked vendors ----------
      - name: Guard - marketplace products query must filter blocked vendors
        run: |
          # we don't know exact file name, so scan lib
          # check presence of vendor.isBlocked filter in products lib
          MATCH1=$(grep -R --line-number -F 'vendor: { isBlocked: false }' src/lib | head -n 1 || true)
          if [ -z "$MATCH1" ]; then
            echo "Missing vendor: { isBlocked: false } filter somewhere in src/lib (expected in getMarketplaceProducts)."
            exit 1
          fi

          # also ensure ACTIVE + isActive appear somewhere around marketplace query
          MATCH2=$(grep -R --line-number -F 'status: "ACTIVE"' src/lib | head -n 1 || true)
          if [ -z "$MATCH2" ]; then
            echo "Missing status: \"ACTIVE\" filter somewhere in src/lib (expected in getMarketplaceProducts)."
            exit 1
          fi

          MATCH3=$(grep -R --line-number -F 'isActive: true' src/lib | head -n 1 || true)
          if [ -z "$MATCH3" ]; then
            echo "Missing isActive: true filter somewhere in src/lib (expected in getMarketplaceProducts)."
            exit 1
          fi

          echo "OK: Found marketplace guard hints:"
          echo "$MATCH1"
          echo "$MATCH2"
          echo "$MATCH3"
