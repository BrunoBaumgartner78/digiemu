name: Blocked Vendor Guards

on:
  push:
    branches: ["main", "develop", "staging"]
  pull_request:
    branches: ["main", "develop", "staging"]

jobs:
  guards:
    runs-on: ubuntu-latest
    
    env:
      DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/postgres?schema=public"

    env:
      DATABASE_URL: "postgresql://ci:ci@127.0.0.1:5432/ci?schema=public"
      DIRECT_URL: "postgresql://ci:ci@127.0.0.1:5432/ci?schema=public"
      FIREBASE_ADMIN_PROJECT_ID: "ci-dummy"
      FIREBASE_ADMIN_CLIENT_EMAIL: "ci-dummy@ci.local"
      FIREBASE_ADMIN_PRIVATE_KEY: |
        -----BEGIN PRIVATE KEY-----
        CI_DUMMY
        -----END PRIVATE KEY-----

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci --include=dev

      - name: Prepare CI env (fallbacks + Prisma pre-steps)
        shell: bash
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          FIREBASE_ADMIN_PROJECT_ID: ${{ secrets.FIREBASE_ADMIN_PROJECT_ID }}
          FIREBASE_ADMIN_CLIENT_EMAIL: ${{ secrets.FIREBASE_ADMIN_CLIENT_EMAIL }}
          FIREBASE_ADMIN_PRIVATE_KEY: ${{ secrets.FIREBASE_ADMIN_PRIVATE_KEY }}
        run: |
          chmod +x ./ci-prepare-env.sh || true
          ./ci-prepare-env.sh

      # optional, but recommended:
      - name: Lint (non-blocking in CI)
        continue-on-error: true
        run: npm run lint --if-present

      - name: Build
        run: npm run build

      # ---------- Guard: Product Page must have blocked checks ----------
      - name: Guard - product page must block inactive/non-ACTIVE and blocked vendors
        shell: bash
        run: |
          set -euo pipefail
          FILE="src/app/product/[id]/page.tsx"
          test -f "$FILE" || (echo "Missing file: $FILE" && exit 1)

          # Accept either:
          # A) runtime guards (legacy)
          # B) query-level enforcement via Prisma where filters (preferred)
          HAS_RUNTIME_ACTIVE="no"
          HAS_RUNTIME_BLOCK="no"
          if grep -F 'status !== "ACTIVE"' "$FILE" >/dev/null 2>&1; then HAS_RUNTIME_ACTIVE="yes"; fi
          if grep -F 'p.vendor?.isBlocked' "$FILE" >/dev/null 2>&1; then HAS_RUNTIME_BLOCK="yes"; fi

          HAS_QUERY_FILTERS="no"
          if grep -E 'findFirst|findUnique' "$FILE" >/dev/null 2>&1 \
            && grep -F 'isActive: true' "$FILE" >/dev/null 2>&1 \
            && grep -F 'status: "ACTIVE"' "$FILE" >/dev/null 2>&1 \
            && grep -F 'vendor: { isBlocked: false }' "$FILE" >/dev/null 2>&1; then
            HAS_QUERY_FILTERS="yes"
          fi

          if [ "$HAS_QUERY_FILTERS" = "yes" ]; then
            echo "✅ Guard OK: query-level filters present (isActive/status/vendor.isBlocked)."
            exit 0
          fi

          if [ "$HAS_RUNTIME_ACTIVE" = "yes" ] && [ "$HAS_RUNTIME_BLOCK" = "yes" ]; then
            echo "✅ Guard OK: runtime guards present."
            exit 0
          fi

          echo "❌ Missing product guards. Need either query-level filters OR runtime guards."
          exit 1

      - name: Guard - relatedProducts must filter blocked vendors
        shell: bash
        run: |
          set -euo pipefail
          FILE="src/app/product/[id]/page.tsx"
          test -f "$FILE" || (echo "Missing file: $FILE" && exit 1)
          # ensure relatedProducts query includes vendor isBlocked false
          grep -F 'vendor: { isBlocked: false }' "$FILE" \
            || (echo "Missing relatedProducts vendor block filter in $FILE" && exit 1)

      # ---------- Guard: Marketplace must filter blocked vendors ----------
      - name: Guard - marketplace products query must filter blocked vendors
        shell: bash
        run: |
          set -euo pipefail
          # scan broader (src/), because query might live outside src/lib
          MATCH1=$(grep -R --line-number -F 'vendor: { isBlocked: false }' src | head -n 1 || true)
          MATCH2=$(grep -R --line-number -F 'status: "ACTIVE"' src | head -n 1 || true)
          MATCH3=$(grep -R --line-number -F 'isActive: true' src | head -n 1 || true)

          if [ -z "$MATCH1" ] || [ -z "$MATCH2" ] || [ -z "$MATCH3" ]; then
            echo "❌ Missing marketplace filters (expected somewhere in src/):"
            echo "  vendor: { isBlocked: false } => ${MATCH1:-MISSING}"
            echo "  status: \"ACTIVE\"           => ${MATCH2:-MISSING}"
            echo "  isActive: true               => ${MATCH3:-MISSING}"
            exit 1
          fi

          echo "✅ OK: Found marketplace guard hints:"
          echo "$MATCH1"
          echo "$MATCH2"
          echo "$MATCH3"
