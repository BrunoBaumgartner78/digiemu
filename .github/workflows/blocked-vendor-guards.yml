name: Blocked Vendor Guards

on:
  push:
    branches: ["main", "develop", "staging"]
  pull_request:
    branches: ["main", "develop", "staging"]

jobs:
  guards:
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/postgres?schema=public"
      DIRECT_URL: "postgresql://postgres:postgres@localhost:5432/postgres?schema=public"
      NEXTAUTH_SECRET: "ci-secret"
      NEXTAUTH_URL: "http://localhost:3000"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Optional: if your repo has a helper script, run it; otherwise skip.
      - name: Prepare CI env (optional helper)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f ".github/scripts/ci-prepare-env.sh" ]; then
            chmod +x .github/scripts/ci-prepare-env.sh
            ./.github/scripts/ci-prepare-env.sh
          else
            echo "ℹ️ .github/scripts/ci-prepare-env.sh not found — skipping."
          fi

      - name: Install deps
        run: npm ci --include=dev

      - name: Lint (if present)
        run: npm run lint --if-present

      - name: Build
        run: npm run build

      # ---------- Guard: Product Page must have blocked checks ----------
      - name: Guard - product page must block inactive/non-ACTIVE and blocked vendors
        shell: bash
        run: |
          set -euo pipefail
          FILE="src/app/product/[id]/page.tsx"
          test -f "$FILE" || (echo "Missing file: $FILE" && exit 1)

          grep -F 'if (!p || !p.isActive || p.status !== "ACTIVE") notFound();' "$FILE" \
            || (echo "Missing ACTIVE guard in $FILE" && exit 1)

          grep -F 'if (p.vendor?.isBlocked) notFound();' "$FILE" \
            || (echo "Missing vendor blocked guard in $FILE" && exit 1)

      - name: Guard - relatedProducts must filter blocked vendors
        shell: bash
        run: |
          set -euo pipefail
          FILE="src/app/product/[id]/page.tsx"
          grep -F 'vendor: { isBlocked: false }' "$FILE" \
            || (echo "Missing relatedProducts vendor block filter in $FILE" && exit 1)

      # ---------- Guard: Marketplace must filter blocked vendors ----------
      - name: Guard - marketplace products query must filter blocked vendors
        shell: bash
        run: |
          set -euo pipefail
          MATCH1=$(grep -R --line-number -F 'vendor: { isBlocked: false }' src/lib | head -n 1 || true)
          if [ -z "$MATCH1" ]; then
            echo "Missing vendor: { isBlocked: false } filter somewhere in src/lib (expected in getMarketplaceProducts)."
            exit 1
          fi

          MATCH2=$(grep -R --line-number -F 'status: "ACTIVE"' src/lib | head -n 1 || true)
          if [ -z "$MATCH2" ]; then
            echo 'Missing status: "ACTIVE" filter somewhere in src/lib (expected in getMarketplaceProducts).'
            exit 1
          fi

          MATCH3=$(grep -R --line-number -F 'isActive: true' src/lib | head -n 1 || true)
          if [ -z "$MATCH3" ]; then
            echo "Missing isActive: true filter somewhere in src/lib (expected in getMarketplaceProducts)."
            exit 1
          fi

          echo "OK: Found marketplace guard hints:"
          echo "$MATCH1"
          echo "$MATCH2"
          echo "$MATCH3"
